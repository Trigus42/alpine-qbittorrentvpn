#!/usr/bin/with-contenv bash
# shellcheck shell=bash

USER=${PUID}
GROUP=${PGID}

QBITTORRENTLOGPATH="/config/qBittorrent/data/logs"
QBITTORRENTLOG="qbittorrent.log"
DAEMON="qbittorrent-nox"
DAEMON_ARGS="--profile=/config"
DAEMONSTRING="$DAEMON $DAEMON_ARGS >> $QBITTORRENTLOGPATH/$QBITTORRENTLOG 2>&1"

umask "${UMASK}"

# Check if log path exists. If it doesn't exist, create it.
if [ ! -e $QBITTORRENTLOGPATH ]; then
	mkdir -p $QBITTORRENTLOGPATH
	chown -R "${PUID}":"${PGID}" /config/qBittorrent
fi

# Check for log file. If it doesn't exist, create it.
if [ -f $QBITTORRENTLOGPATH/$QBITTORRENTLOG ]; then
	echo "$(date +'%Y-%m-%d %H:%M:%S') [INFO] Logging to $QBITTORRENTLOGPATH/$QBITTORRENTLOG."
else
	echo "$(date +'%Y-%m-%d %H:%M:%S') [INFO] Log file $QBITTORRENTLOGPATH/$QBITTORRENTLOG doesn't exist. Creating it..."
	touch "$QBITTORRENTLOGPATH/$QBITTORRENTLOG"
	if [ -f "$QBITTORRENTLOGPATH/$QBITTORRENTLOG" ]; then
		chown "$USER":"$GROUP" $QBITTORRENTLOGPATH/$QBITTORRENTLOG
		echo "$(date +'%Y-%m-%d %H:%M:%S') [INFO] Logfile created. Logging to $QBITTORRENTLOGPATH/$QBITTORRENTLOG"
	else
		echo "$(date +'%Y-%m-%d %H:%M:%S') [WARNING] Couldn't create logfile $QBITTORRENTLOGPATH/$QBITTORRENTLOG"
	fi
fi

# Check if it is possible to bypass the VPN
if (timeout 0.5 ping -I "$DOCKER_INTERFACE" -c 1 "1.1.1.1" > /dev/null 2>&1) || (timeout 0.5 ping -I "$DOCKER_INTERFACE" -c 1 "8.8.8.8" > /dev/null 2>&1); then
	echo "$(date +'%Y-%m-%d %H:%M:%S') [ERROR] Firewall is down! Exiting.."
	exit 1
fi

exec s6-setuidgid "$(getent passwd "$PUID" | cut -d: -f1)" /bin/bash -c "$DAEMONSTRING"